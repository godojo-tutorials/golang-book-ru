name: ğŸ“š Content Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'content/**'
      - 'code/**'
      - 'exercises/**'
      - 'templates/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'content/**'
      - 'code/**'
      - 'exercises/**'
      - 'templates/**'

env:
  NODE_VERSION: '18'
  GO_VERSION: '1.21'

jobs:
  # Content Quality Validation
  content-quality:
    name: ğŸ” Content Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install Dependencies
        run: npm ci

      - name: ğŸ“ Validate Content Structure
        run: |
          echo "ğŸ” Checking content structure..."
          npm run structure:validate

      - name: ğŸ“Š Content Quality Check
        run: |
          echo "ğŸ“Š Validating content quality standards..."
          npm run content:check

      - name: ğŸ”— Link Validation
        run: |
          echo "ğŸ”— Validating internal and external links..."
          npm run links:check || echo "âš ï¸ Link check completed with warnings"

      - name: ğŸ“ Content Length Validation
        run: |
          echo "ğŸ“ Checking minimum content length requirements..."
          
          # Check word count for all content files
          find content -name "*.md" -type f | while read file; do
            word_count=$(wc -w < "$file")
            echo "ğŸ“„ $file: $word_count words"
          
            if [[ $word_count -lt 800 && ! "$file" =~ README\.md$ ]]; then
              echo "âš ï¸ WARNING: $file has only $word_count words (minimum: 800)"
            fi
          done

  # Go Code Validation
  code-validation:
    name: ğŸ’» Code Examples Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: âœ… Compile Go Examples
        run: |
          echo "âœ… Compiling all Go code examples..."
          
          # Find and compile all Go files
          find code -name "*.go" -type f | while read -r file; do
            echo "Checking: $file"
          
            # Try to build the file
            if go build -o /tmp/test_binary "$file" 2>/dev/null; then
              echo "âœ… $file compiles successfully"
              rm -f /tmp/test_binary
            else
              echo "âŒ $file failed to compile"
              go build "$file" # Show error details
              exit 1
            fi
          done

      - name: ğŸ§ª Run Go Tests
        run: |
          echo "ğŸ§ª Running Go tests if present..."
          
          # Find directories with test files
          find code -name "*_test.go" -type f | while read -r test_file; do
            dir=$(dirname "$test_file")
            echo "Testing directory: $dir"
          
            (cd "$dir" && go test -v .) || echo "âš ï¸ Tests failed in $dir"
          done

      - name: ğŸ” Go Vet Analysis
        run: |
          echo "ğŸ” Running go vet on all examples..."
          
          find code -name "*.go" -type f | while read -r file; do
            dir=$(dirname "$file")
            echo "Vetting: $file"
          
            (cd "$dir" && go vet .) || echo "âš ï¸ Vet issues in $dir"
          done

      - name: ğŸ“ Go Format Check
        run: |
          echo "ğŸ“ Checking Go code formatting..."
          
          unformatted=$(find code -name "*.go" -type f | xargs gofmt -l)
          
          if [ -n "$unformatted" ]; then
            echo "âŒ Unformatted Go files found:"
            echo "$unformatted"
            echo ""
            echo "Run 'gofmt -w' on these files to fix formatting"
            exit 1
          fi
          
          echo "âœ… All Go files are properly formatted"

  # Documentation and Markdown
  documentation:
    name: ğŸ“– Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install Dependencies
        run: npm ci

      - name: ğŸ“ Markdown Lint
        run: |
          echo "ğŸ“ Linting Markdown files..."
          
          # Basic markdown validation
          find . -name "*.md" -type f | while read file; do
            echo "Checking: $file"
            # Basic checks - no empty files, proper structure
            if [[ ! -s "$file" ]]; then
              echo "âš ï¸ WARNING: $file is empty"
            fi
          done

      - name: ğŸ”¤ Spell Check (Basic)
        run: |
          echo "ğŸ”¤ Running basic spell check..."
          
          # Check for common typos
          find content -name "*.md" -type f -exec grep -l "teh\|recieve\|seperate\|occured" {} \; | while read file; do
            echo "âš ï¸ Possible typos in: $file"
          done || echo "âœ… No obvious typos found"

      - name: ğŸ“Š Content Statistics
        run: |
          echo "ğŸ“Š Generating content statistics..."
          
          total_content=$(find content -name "*.md" | wc -l)
          total_code=$(find code -name "*.go" | wc -l)
          total_exercises=$(find exercises -name "*.md" | wc -l)
          total_words=$(find content -name "*.md" -exec wc -w {} + 2>/dev/null | tail -n1 | awk '{print $1}' || echo "0")
          
          echo "ğŸ“ˆ Statistics:"
          echo "  - Content files: $total_content"
          echo "  - Code examples: $total_code"
          echo "  - Exercise files: $total_exercises"
          echo "  - Total words: $total_words"

  # Security and Dependencies
  security:
    name: ğŸ”’ Security Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ” Security Audit
        run: |
          echo "ğŸ” Running npm security audit..."
          npm audit --audit-level=moderate || echo "âš ï¸ Security issues found - review recommended"

      - name: ğŸ“‹ License Check
        run: |
          echo "ğŸ“‹ Checking license file..."
          
          if [[ -f "LICENSE" ]]; then
            echo "âœ… LICENSE file exists"
            echo "License type: $(head -n1 LICENSE)"
          else
            echo "âŒ LICENSE file missing"
            exit 1
          fi

  # Validation Summary
  validation-summary:
    name: ğŸ“‹ Validation Summary
    runs-on: ubuntu-latest
    needs: [content-quality, code-validation, documentation, security]
    if: always()
    steps:
      - name: ğŸ“‹ Generate Summary
        run: |
          echo "## ğŸ“‹ Content Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Content Quality | ${{ needs.content-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Validation | ${{ needs.code-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.documentation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.content-quality.result }}" == "success" && 
                "${{ needs.code-validation.result }}" == "success" && 
                "${{ needs.documentation.result }}" == "success" && 
                "${{ needs.security.result }}" == "success" ]]; then
            echo "ğŸ‰ **All validations passed!** Content is ready for merge." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some validations failed.** Please review and fix issues before merging." >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ”” Validation Status
        run: |
          if [[ "${{ needs.content-quality.result }}" == "success" && 
                "${{ needs.code-validation.result }}" == "success" && 
                "${{ needs.documentation.result }}" == "success" && 
                "${{ needs.security.result }}" == "success" ]]; then
            echo "âœ… All validations passed successfully!"
          else
            echo "âŒ Some validations failed - check the logs above"
            exit 1
          fi